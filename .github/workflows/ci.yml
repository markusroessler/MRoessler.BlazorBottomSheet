name: CI Build

on: [push, workflow_dispatch]
permissions:
  contents: write
  packages: read

env:
  DOTNET_VERSION: ${{ vars.DOTNET_VERSION }}
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  NUGET_MROESSLER_GITHUB_PWD: ${{ secrets.NUGET_READ }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Configure Git
      run: |
        # see https://api.github.com/users/github-actions%5Bbot%5D
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
    
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: "*/*.csproj"

    - name: Remove setup-dotnet problem matcher
      run: echo "::remove-matcher owner=csc::"
    
    - name: Restore
      run: dotnet restore

    - name: Restore tools
      run: dotnet tool restore
    
    - name: Build
      id: build
      run: dotnet build -p:ErrorLog="compiler-diagnostics.sarif%2Cversion=2.1" --no-restore

    - name: Collect build results
      id: collect-build-results
      if: always()
      run: dotnet export-dotnet-results-for-github --export-step-summary true --github-server-url ${{ github.server_url }} --github-repo ${{ github.repository }} --github-ref-name ${{ github.ref_name }} --culture "de-DE"

    - name: Publish lines of code
      if: always()
      run: |
        bash .github/scripts/print-lines-of-code.sh >> $GITHUB_STEP_SUMMARY


  test:
    name: Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        browser: [chromium, webkit]

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: "*/*.csproj"

    - name: Remove setup-dotnet problem matcher
      run: echo "::remove-matcher owner=csc::"

    - name: Install npm packages
      run: npm install -g nyc

    - name: Instrument js files for code coverage
      if: always()
      run: nyc instrument ./MRoessler.BlazorBottomSheet ./MRoessler.BlazorBottomSheet --in-place --compact false

    - name: Restore
      run: dotnet restore

    - name: Restore tools
      run: dotnet tool restore
    
    - name: Build
      id: build
      run: dotnet build  -p:ErrorLog="compiler-diagnostics.sarif%2Cversion=2.1" --no-restore

    - name: Setup Playwright
      if: always()
      run: pwsh Sample.Test/bin/Debug/net10.0/playwright.ps1 install --with-deps ${{ matrix.browser }}

    - name: Test
      if: always()
      run: |
        dotnet test -c:Debug -f:net10.0 --no-build --filter TestCategory!~sample --logger:html \
        --logger:"trx;LogFileName=TestResults/TestResults.trx" --collect:"XPlat Code Coverage" --settings ci-${{ matrix.browser }}.runsettings
      
    - name: Convert js coverage results
      run: |
        git restore MRoessler.BlazorBottomSheet
        nyc report --reporter=cobertura --report-dir js-coverage-report
      if: always()

    - name: Collect build results
      id: collect-build-results
      if: always()
      run: dotnet export-dotnet-results-for-github --export-step-summary true --github-server-url ${{ github.server_url }} --github-repo ${{ github.repository }} --github-ref-name ${{ github.ref_name }} --culture "de-DE"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
      with:
        name: blazor-bottomsheet-ci-test-results-${{ matrix.browser }}
        path: |
          **/TestResults/*.html
          Sample.Test/**/Screenshots/*.png
          **/TestResults/*/coverage.cobertura.xml
          js-coverage-report/cobertura-coverage.xml


  generate-test-report:
    name: Generate test report
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
     
      - name: Configure Git
        run: |
          # see https://api.github.com/users/github-actions%5Bbot%5D
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: "*/*.csproj"

      - name: Restore tools
        run: dotnet tool restore

      - name: Download test results (chromium)
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        continue-on-error: true
        with:
          name: blazor-bottomsheet-ci-test-results-chromium
          path: TestResults/chromium

      - name: Download test results (webkit)
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        continue-on-error: true
        with:
          name: blazor-bottomsheet-ci-test-results-webkit
          path: TestResults/webkit

      - name: Generate coverage report
        run: dotnet reportgenerator
      
      - name: Upload test report
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: blazor-bottomsheet-ci-test-report
          path: TestResults

      # push badges to tag without attaching the commit to a branch (for readme.md)
      - name: Commit badges
        if: github.ref_name == 'main'
        run: |
          mkdir badges
          mv TestResults/coverage-report/badge_linecoverage.svg badges
          bash .github/scripts/export-lines-of-code-badge.sh
          git add badges/*
          git commit -m "updated badges"
          git tag build-results 
          git push --force origin build-results

      - name: Publish coverage results
        run: | 
          echo "## Coverage Results" >> $GITHUB_STEP_SUMMARY
          cat TestResults/coverage-report/SummaryGithub.md | sed -e 's/# Summary//g' >> $GITHUB_STEP_SUMMARY
