name: CI Build

on: [push, workflow_dispatch]
permissions:
  contents: read
  packages: read


jobs:
  dotnet-linux:
    name: .NET (Linux)
    runs-on: ubuntu-latest

    env:
      DOTNET_VERSION: 10.0.101
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
      NUGET_MROESSLER_GITHUB_PWD: ${{ secrets.NUGET_READ }}

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: Git Config
      run: |
        # prevent git error "detected dubious ownership in repository at '...'"
        git config --global --add safe.directory $GITHUB_WORKSPACE
    
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: "*/*.csproj"

    - name: Remove setup-dotnet problem matcher
      run: echo "::remove-matcher owner=csc::"
    
    - name: Install nyc
      run: npm install -g nyc 

    - name: Instrument js files for code coverage
      run: nyc instrument ./MRoessler.BlazorBottomSheet ./MRoessler.BlazorBottomSheet --in-place --compact false

    - name: Restore
      run: dotnet restore

    - name: Restore tools
      run: dotnet tool restore
    
    - name: Build
      id: build
      run: |
        dotnet build -c:Debug -p:ErrorLog="compiler-diagnostics.sarif%2Cversion=2.1" --no-restore
    
    - name: Setup Playwright
      run: pwsh MRoessler.BlazorBottomSheet.Sample.Test/bin/Debug/net10.0/playwright.ps1 install

    - name: Test
      if: always()
      run: |
        dotnet test -c:Debug -f:net10.0 --no-build --filter TestCategory!~sample --logger:html \
        --logger:"trx;LogFileName=TestResults/TestResults.trx" --collect:"XPlat Code Coverage" --settings ci.runsettings

    - name: Convert js coverage results
      run: nyc report --reporter=text --reporter=html --report-dir js-coverage-report >> js-coverage-report.txt
      if: always()

    - name: Collect Build Results
      id: collect-build-results
      if: always()
      run: dotnet export-dotnet-results-for-github --export-step-summary true --github-server-url ${{ github.server_url }} --github-repo ${{ github.repository }} --github-ref-name ${{ github.ref_name }} --culture "de-DE"

    - name: Generate Coverage Report
      if: always()
      run: dotnet reportgenerator
    
    - name: Upload Coverage Report
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: blazor-bottomsheet-ci-linux-coverage-report
        path: |
          TestResults/coverage-report
          js-coverage-report

    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: blazor-bottomsheet-ci-linux-test-report
        path: '**/TestResults/*.html'

    - name: Publish Coverage Results
      if: always()
      run: | 
        echo "## Coverage Results" >> $GITHUB_STEP_SUMMARY
        echo "### C#" >> $GITHUB_STEP_SUMMARY
        cat TestResults/coverage-report/SummaryGithub.md | sed -e 's/# Summary//g' >> $GITHUB_STEP_SUMMARY
        
        echo "### Javascript" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        cat js-coverage-report.txt >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
    
    - name: Publish Lines of Code
      if: always()
      run: |
        bash .github/scripts/print-lines-of-code.sh >> $GITHUB_STEP_SUMMARY