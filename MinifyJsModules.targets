<!-- implementation template: https://github.com/dotnet/sdk/blob/e90c4413024970eca97d05122243737aa207af11/src/StaticWebAssetsSdk/Targets/Microsoft.NET.Sdk.StaticWebAssets.JSModules.targets#L428 -->
<Project>
  <PropertyGroup>
    <GenerateComputedBuildStaticWebAssetsDependsOn>$(GenerateComputedBuildStaticWebAssetsDependsOn);MinifyJsModules</GenerateComputedBuildStaticWebAssetsDependsOn>
  </PropertyGroup>

  <Target Name="MinifyJsModules">
    <ItemGroup>
      <_WebAssetMinifyInput Include="**/*.razor.js" Exclude="**/bin/**;**/obj/**" />
      <_FingerprintPattern Include="ComponentsMinJsModule" Pattern="*.razor.min.js"/>
    </ItemGroup>
    <PropertyGroup>
      <_MinifyOutputDir>$(IntermediateOutputPath)bundled</_MinifyOutputDir>
    </PropertyGroup>
    <!-- <Message Importance="high" Text="_WebAssetMinifyInput: %(_WebAssetMinifyInput.Identity)" /> -->

    <Exec Command="npx esbuild @(_WebAssetMinifyInput, ' ') --minify --sourcemap --out-extension:.js=.min.js --outbase=. --outdir=&quot;$(_MinifyOutputDir)&quot;" />
    <ItemGroup>
      <_WebAssetMinifyOutput Include="$(_MinifyOutputDir)\**" />
    </ItemGroup>
    <!-- <Message Importance="high" Text="_WebAssetMinifyOutput: %(_WebAssetMinifyOutput.Identity)" /> -->

    <DefineStaticWebAssets CandidateAssets="@(_WebAssetMinifyOutput)"
        SourceId="$(PackageId)"
        SourceType="Computed"
        ContentRoot="$(_MinifyOutputDir)"
        BasePath="_content/$(PackageId)"
        AssetKind="All"
        AssetMode="All"
        AssetRole="Primary"
        AssetMergeSource="$(StaticWebAssetMergeTarget)"
        FingerprintCandidates="$(StaticWebAssetsFingerprintContent)"
        FingerprintPatterns="@(_FingerprintPattern)">
      <Output TaskParameter="Assets" ItemName="_MinifiedStaticWebAsset" />
    </DefineStaticWebAssets>

    <DefineStaticWebAssetEndpoints CandidateAssets="@(_MinifiedStaticWebAsset)"
        ExistingEndpoints="@(StaticWebAssetEndpoint)"
        ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
        >
      <Output TaskParameter="Endpoints" ItemName="_MinifiedStaticWebAssetEndpoint" />
    </DefineStaticWebAssetEndpoints>

    <ItemGroup>
      <StaticWebAsset Include="@(_MinifiedStaticWebAsset)" />
      <StaticWebAssetEndpoint Include="@(_MinifiedStaticWebAssetEndpoint)" />
      
      <!-- Append a property 'script-type' so that we include the file on the import map -->
      <!-- <_AddPropertyToInitializers Include="Append">
          <UpdateTarget>Property</UpdateTarget>
          <Name>script-type</Name>
          <Value>module</Value>
      </_AddPropertyToInitializers> -->

       <!-- Append a property 'dependency-group' so that we can link and preload the file without using the name -->
      <!-- <_AddPropertyToInitializers Include="Append">
        <UpdateTarget>Property</UpdateTarget>
        <Name>dependency-group</Name>
        <Value>js-initializer</Value>
      </_AddPropertyToInitializers> -->
    </ItemGroup>

    <!-- <UpdateStaticWebAssetEndpoints
        Condition="'@(_AddPropertyToInitializers)' != ''"
        EndpointsToUpdate="@(_MinifiedStaticWebAssetEndpoint)"
        AllEndpoints="@(StaticWebAssetEndpoint)"
        Operations="@(_AddPropertyToInitializers)"
      >
        <Output TaskParameter="UpdatedEndpoints" ItemName="_FilteredMyBundleStaticWebAssetEndpointWithProperty" />
    </UpdateStaticWebAssetEndpoints>

    <ItemGroup>
      <StaticWebAssetEndpoint Remove="@(_FilteredMyBundleStaticWebAssetEndpointWithProperty)" />
      <StaticWebAssetEndpoint Include="@(_FilteredMyBundleStaticWebAssetEndpointWithProperty)" />
    </ItemGroup> -->
  </Target>
</Project>